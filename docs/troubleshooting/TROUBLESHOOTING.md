# üö® Troubleshooting et FAQ

## Probl√®mes Fr√©quents et Solutions

### üîê Probl√®mes d'Authentification et Certificats

#### Certificats HTTPS non reconnus
**Sympt√¥mes :**
- Avertissement de s√©curit√© dans le navigateur
- "Votre connexion n'est pas priv√©e"
- ERR_CERT_AUTHORITY_INVALID

**Solutions :**

**Windows :**
```powershell
# Option 1: Accepter temporairement
# 1. Ouvrir Chrome/Edge
# 2. Aller √† https://dev.tcgbot.local:3000
# 3. Cliquer "Avanc√©" ‚Üí "Continuer vers le site"

# Option 2: Installer les certificats (permanente)
# 1. Double-cliquer sur dev.tcgbot.local.pem
# 2. "Installer le certificat"
# 3. Choisir "Ordinateur local"
# 4. "Placer tous les certificats dans le magasin suivant"
# 5. S√©lectionner "Autorit√©s de certification racines de confiance"
```

**macOS :**
```bash
# Ajouter le certificat au trousseau
sudo security add-trusted-cert -d -r trustRoot -k /System/Library/Keychains/SystemRootCertificates.keychain dev.tcgbot.local.pem
```

**Linux :**
```bash
# Copier le certificat dans le dossier des certificats
sudo cp dev.tcgbot.local.pem /usr/local/share/ca-certificates/dev.tcgbot.local.crt
sudo update-ca-certificates
```

#### Erreur "dev.tcgbot.local" non r√©solu
**Sympt√¥mes :**
- ERR_NAME_NOT_RESOLVED
- "Impossible d'acc√©der au site"

**Solution :**
```bash
# Windows
echo 127.0.0.1 dev.tcgbot.local >> C:\Windows\System32\drivers\etc\hosts

# macOS/Linux  
echo "127.0.0.1 dev.tcgbot.local" | sudo tee -a /etc/hosts

# V√©rifier la modification
ping dev.tcgbot.local
```

### üîÑ Probl√®mes de Proxies API

#### Proxies non accessibles
**Sympt√¥mes :**
- ERR_CONNECTION_REFUSED
- "Failed to fetch"
- Timeout des requ√™tes API

**Diagnostic :**
```powershell
# Windows PowerShell - V√©rifier les ports
netstat -an | findstr :8021  # CardTrader
netstat -an | findstr :8020  # Lorcast  
netstat -an | findstr :8010  # JustTCG

# Alternative avec Get-NetTCPConnection
Get-NetTCPConnection -LocalPort 8021,8020,8010 -State Listen
```

**Solutions :**
```bash
# Red√©marrer les proxies dans l'ordre
# Terminal 1
node server/cardtrader-proxy.mjs

# Terminal 2  
node server/lorcast-proxy.mjs

# Terminal 3
node justtcg-proxy.mjs

# V√©rifier les logs pour erreurs
```

#### Erreurs de CORS
**Sympt√¥mes :**
- "Access to fetch blocked by CORS policy"
- "No 'Access-Control-Allow-Origin' header"

**Solution :**
V√©rifier la configuration CORS dans les proxies :
```javascript
// server/cardtrader-proxy.mjs
app.use(cors({
    origin: [
        'https://dev.tcgbot.local:3000',
        'http://localhost:3000'
    ],
    credentials: true
}));
```

### ‚öôÔ∏è Probl√®mes de Configuration

#### Variables d'environnement manquantes
**Sympt√¥mes :**
- "Environment variable not found"
- Fonctionnalit√©s partiellement disponibles

**Diagnostic :**
```bash
# V√©rifier l'existence du fichier
ls -la .env.local

# V√©rifier le contenu (sans afficher les valeurs sensibles)
grep -E "^[A-Z_]+" .env.local
```

**Solution :**
```env
# Template .env.local complet
# Supabase
VITE_SUPABASE_URL=https://votre-projet.supabase.co
VITE_SUPABASE_ANON_KEY=votre_cle_anon

# CardTrader
VITE_CARDTRADER_API_TOKEN=votre_token_cardtrader
REACT_APP_CARDTRADER_API_TOKEN=votre_token_cardtrader

# D√©veloppement
VITE_SITE_URL=https://dev.tcgbot.local:3000
HTTPS=true
```

#### Erreurs de connexion Supabase
**Sympt√¥mes :**
- "Invalid API key"
- "Project not found"
- Probl√®mes d'authentification

**Solutions :**
1. **V√©rifier l'URL et la cl√© :**
   ```javascript
   // src/supabaseClient.js
   console.log('Supabase URL:', import.meta.env.VITE_SUPABASE_URL);
   console.log('Anon Key pr√©sente:', !!import.meta.env.VITE_SUPABASE_ANON_KEY);
   ```

2. **V√©rifier les politiques RLS :**
   ```sql
   -- Dans Supabase Studio
   SELECT * FROM pg_policies WHERE tablename = 'collections';
   ```

3. **Tester la connexion :**
   ```javascript
   // Console d√©veloppeur
   const { data, error } = await supabase.from('collections').select('*').limit(1);
   console.log('Test connexion:', { data, error });
   ```

### üóÑÔ∏è Probl√®mes de Base de Donn√©es

#### Migrations non appliqu√©es
**Sympt√¥mes :**
- "Relation does not exist"
- "Column does not exist"
- Erreurs SQL dans la console

**Solution :**
```sql
-- V√©rifier les tables existantes
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public';

-- Appliquer les migrations manquantes
-- Dans Supabase Studio > SQL Editor
\i 'db/migrations/create_listings_table.sql'
\i 'db/migrations/add_is_foil_to_price_history.sql'
```

#### Probl√®mes de permissions RLS
**Sympt√¥mes :**
- "Insufficient permissions"
- Donn√©es non visibles malgr√© l'authentification

**Diagnostic :**
```sql
-- V√©rifier l'utilisateur actuel
SELECT auth.uid(), auth.email();

-- V√©rifier les politiques
SELECT schemaname, tablename, policyname, cmd, qual 
FROM pg_policies 
WHERE schemaname = 'public';
```

**Solution :**
```sql
-- R√©initialiser les politiques de base
DROP POLICY IF EXISTS "Users can view own collections" ON collections;
CREATE POLICY "Users can view own collections" ON collections
    FOR ALL USING (auth.uid() = user_id);
```

### üöÄ Probl√®mes de Performance

#### Application lente au d√©marrage
**Sympt√¥mes :**
- Temps de chargement > 5 secondes
- "Building..." prolong√©

**Solutions :**
```bash
# Nettoyer le cache
rm -rf node_modules/.vite
rm -rf node_modules/.cache

# R√©installer les d√©pendances
rm -rf node_modules package-lock.json
npm install

# Build optimis√©
npm run build
npm run preview
```

#### Requ√™tes API lentes
**Sympt√¥mes :**
- Timeouts fr√©quents
- Recherches qui tra√Ænent

**Diagnostic :**
```javascript
// Mesurer les performances API
console.time('API Call');
const result = await cardTraderAPI.searchCards(query);
console.timeEnd('API Call');
```

**Solutions :**
1. **Optimiser le cache :**
   ```javascript
   // Augmenter les TTL dans les proxies
   const CACHE_TTL = {
       games: 24 * 60 * 60 * 1000,      // 24h
       expansions: 12 * 60 * 60 * 1000,  // 12h
       blueprints: 6 * 60 * 60 * 1000    // 6h
   };
   ```

2. **Impl√©menter la pagination :**
   ```javascript
   // Limiter les r√©sultats
   const searchWithPagination = async (query, page = 1, limit = 20) => {
       return await api.search({ query, page, limit });
   };
   ```

### üß™ Probl√®mes de D√©veloppement

#### Hot reload ne fonctionne pas
**Sympt√¥mes :**
- Modifications non refl√©t√©es automatiquement
- Besoin de rafra√Æchir manuellement

**Solutions :**
```javascript
// vite.config.js
export default defineConfig({
    server: {
        watch: {
            usePolling: true,
            interval: 100
        }
    }
});
```

#### Erreurs ESLint/Prettier
**Sympt√¥mes :**
- Warnings en masse
- Formatage incoh√©rent

**Solutions :**
```bash
# Auto-fix des erreurs corrigibles
npm run lint:fix
npm run format

# Ignorer temporairement
// eslint-disable-next-line rule-name
const problematicCode = something;
```

## üîß Outils de Diagnostic

### Script de Diagnostic Complet
```javascript
// scripts/diagnose.js
const diagnostic = {
    async checkEnvironment() {
        console.log('üîç V√©rification environnement...');
        
        const requiredVars = [
            'VITE_SUPABASE_URL',
            'VITE_SUPABASE_ANON_KEY', 
            'VITE_CARDTRADER_API_TOKEN'
        ];
        
        requiredVars.forEach(varName => {
            const value = process.env[varName];
            console.log(`${varName}: ${value ? '‚úÖ' : '‚ùå'}`);
        });
    },
    
    async checkPorts() {
        console.log('üîç V√©rification ports...');
        
        const ports = [3000, 8010, 8020, 8021];
        
        for (const port of ports) {
            try {
                const response = await fetch(`http://localhost:${port}`);
                console.log(`Port ${port}: ‚úÖ`);
            } catch (error) {
                console.log(`Port ${port}: ‚ùå`);
            }
        }
    },
    
    async checkDatabase() {
        console.log('üîç V√©rification base de donn√©es...');
        
        try {
            const { data, error } = await supabase
                .from('collections')
                .select('count')
                .limit(1);
                
            console.log('Connexion Supabase:', error ? '‚ùå' : '‚úÖ');
        } catch (error) {
            console.log('Connexion Supabase: ‚ùå', error.message);
        }
    }
};

// Ex√©cuter tous les diagnostics
diagnostic.checkEnvironment();
diagnostic.checkPorts();
diagnostic.checkDatabase();
```

### Commandes de Debug Rapides
```bash
# V√©rifier tous les processus Node.js
ps aux | grep node

# V√©rifier les ports occup√©s
netstat -tulpn | grep :80

# Logs en temps r√©el des proxies
tail -f server/logs/*.log

# Test de connectivit√© API
curl -H "Authorization: Bearer $VITE_CARDTRADER_API_TOKEN" \
     https://api.cardtrader.com/api/v2/games
```

## üìö FAQ

### Q : Comment r√©initialiser compl√®tement l'environnement ?
```bash
# Arr√™ter tous les processus
pkill -f "node.*proxy"

# Nettoyer compl√®tement
rm -rf node_modules package-lock.json
rm -rf .vite
npm install

# Red√©marrer proprement
npm run start
```

### Q : Les images de cartes ne se chargent pas ?
- V√©rifier les URLs d'images dans la base de donn√©es
- Tester l'acc√®s direct aux URLs d'images
- V√©rifier les politiques CORS des serveurs d'images

### Q : Comment d√©boguer les erreurs de listing CardTrader ?
```javascript
// Activer les logs d√©taill√©s
const debug = true;

if (debug) {
    console.log('Donn√©es envoy√©es:', listingData);
    console.log('R√©ponse API:', response);
}
```

### Q : L'application ne se lance pas sur le port 3000 ?
```bash
# Trouver le processus utilisant le port
lsof -ti:3000

# Arr√™ter le processus
kill -9 $(lsof -ti:3000)

# Ou utiliser un autre port
PORT=3001 npm run dev
```

## üö® En Cas d'Urgence

### Restauration Rapide
1. **Sauvegarder les donn√©es** critiques
2. **Git reset** au dernier commit stable
3. **Red√©marrer tous les services**
4. **V√©rifier la configuration**

### Contacts et Support
- **Documentation** : `/docs` folder
- **Issues GitHub** : Repository issues
- **Logs d√©taill√©s** : Console navigateur + serveur
- **Supabase Dashboard** : Interface compl√®te BDD

---

## üìö Documentation Connexe

### Configuration et Installation
- [üöÄ Installation](../02-INSTALLATION-GUIDE.md) - Guide complet de configuration
- [üíª D√©veloppement](../05-DEVELOPMENT.md) - Scripts et outils de debugging
- [üåê D√©ploiement](../deployment/DEPLOYMENT.md) - Probl√®mes de production

### Architecture Technique
- [üèóÔ∏è Architecture](../03-ARCHITECTURE.md) - Comprendre la structure syst√®me
- [üîå APIs](../06-APIS.md) - Configuration des proxies et endpoints
- [üóÑÔ∏è Base de Donn√©es](../04-DATABASE.md) - Probl√®mes de connexion Supabase

### Fonctionnalit√©s Sp√©cifiques
- [üõí Listings CardTrader](../features/CARDTRADER-LISTINGS.md) - Debug marketplace
- [üìñ Vue d'ensemble](../01-PROJECT-OVERVIEW.md) - Contexte fonctionnel

---

**En cas de probl√®me non couvert, v√©rifier d'abord les logs de la console d√©veloppeur et des serveurs proxy pour identifier la source de l'erreur.**
